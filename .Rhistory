-PET_Flag,
-ASTC_Flag,
-Lithotripsy_Flag,
-MRI_MRA_Flag,
-Megavolt_Rad_Flag,
-CT_Flag,
-Fatal_Error_Flag,
-starts_with("Record_Num"), #[1:2]
-Bill_End,
-MUL,
-Patient_ID,
-TN_Co_Res,
-Payer_A,
-Payer_B,
-Payer_C,
-Amount_Counter,
-Race,
-LOS,
-DRG_Rank,
-Inpat_Record_Flag,
-ER_Record_Flag,
-ASTC_Record_Flag,
-Obs_23hr_Record_Flag,
-CON_Flag,
-Cumulative_Record_Flag,
-Reportable_Flag,
-TN_Co_Unk,
-Processing_Period,
-MS_MDC,
-MS_DRG,
-MS_DRG_4digit,
-HAC,
-Admit_From_ED_Flag,
-Wrong_Claim
)
train1 <- train$Diag1 %>%
paste(df$Diag1,
df$Diag2,
df$Diag3,
df$Diag4,
df$Diag5,
df$Diag6,
df$Diag7,
df$Diag8,
df$Diag9,
df$Diag10,
df$Diag11,
df$Diag12,
df$Diag13,
df$Diag14,
df$Diag15,
df$Diag16,
df$Diag17,
df$Diag18
)
keep<-grep(ICD_Filtered$X2, df$Diag1)
View(ICD_Filtered)
#Reads and formats ICD-10 2019 Codebook
ICD <- readr::read_delim("D:/DataLab/syndemic/icd10cm_order_2019.txt", delim = ' ', col_names = FALSE) %>%
select(-X1, -X3, -X4) %>%
unite(col = 'Details', X5:X62, sep = ' ', na.rm = TRUE)
#Filters Codebook to only words we deem relevant
ICD_Filtered <- ICD %>%
filter(grepl('endocarditis |
sepsis |
osteomyelitis |
Human immunodef virus|
HIV |
syphilis |
gonorrhoea |
chlamydia |
trichomoniasis |
sexually transmitted infection |
hepatitis A |
hepatitis B |
hepatitis C |
hepatitis D |
hepatitis E |
substance use',
Details,
ignore.case = TRUE))
View(ICD_Filtered)
#Filters Codebook to only words we deem relevant
ICD_Filtered <- ICD %>%
filter(grepl('endocarditis|sepsis|osteomyelitis|Human immunodef virus|HIV|syphilis|gonorrhoea|chlamydia|trichomoniasis|sexually transmitted infection|hepatitis A|hepatitis B|hepatitis C|hepatitis D|hepatitis E|substance use',
Details,
ignore.case = TRUE))
#Filters out unnecessary columns
train <-df %>% select(
-Type_Bill,
-Fed_Tax_SubID,
-Fed_Tax_Num,
-Admission_Type,
-Admission_Source,
-Do_Not_Resuscitate,
-Accident_St,
-starts_with("Units_Service"), #[1:18]
-Primary_Health_Plan_Id,
-Secondary_Health_Plan_Id,
-Tertiary_Health_Plan_Id,
-Primary_Patient_Rel_Insr,
-Secondary_Patient_Rel_Insr,
-Tertiary_Patient_Rel_Insr,
-Dx_Px_Qualifier,
-starts_with("POA"), #[1:18]
-starts_with("Patient_Reason_Visit"),#[1:3],
-Prospect_Pay_Code,
-starts_with("Ecode"), #[1:3]
-starts_with("E_POA"), #[1:3]
-Type_ER_Visit,
-Outcome_ER_Visit,
-Inpatient_Flag,
-ER_Flag,
-PET_Flag,
-ASTC_Flag,
-Lithotripsy_Flag,
-MRI_MRA_Flag,
-Megavolt_Rad_Flag,
-CT_Flag,
-Fatal_Error_Flag,
-starts_with("Record_Num"), #[1:2]
-Bill_End,
-MUL,
-Patient_ID,
-TN_Co_Res,
-Payer_A,
-Payer_B,
-Payer_C,
-Amount_Counter,
-Race,
-LOS,
-DRG_Rank,
-Inpat_Record_Flag,
-ER_Record_Flag,
-ASTC_Record_Flag,
-Obs_23hr_Record_Flag,
-CON_Flag,
-Cumulative_Record_Flag,
-Reportable_Flag,
-TN_Co_Unk,
-Processing_Period,
-MS_MDC,
-MS_DRG,
-MS_DRG_4digit,
-HAC,
-Admit_From_ED_Flag,
-Wrong_Claim
)
train1 <- train$Diag1 %>%
paste(df$Diag1,
df$Diag2,
df$Diag3,
df$Diag4,
df$Diag5,
df$Diag6,
df$Diag7,
df$Diag8,
df$Diag9,
df$Diag10,
df$Diag11,
df$Diag12,
df$Diag13,
df$Diag14,
df$Diag15,
df$Diag16,
df$Diag17,
df$Diag18
)
ICD_Filtered[1,2]
keep<-(ICD_Filtered[i,1])
ICD_Filtered[1,1]
ICD_Filtered[2,1]
keepall<-c()
for(i in 1:492){
keep<-(ICD_Filtered[i,1],train1$Diag1)
keepall<-keep
}
keepall<-c()
for(i in 1:492){
keep<-grep(ICD_Filtered[i,1],train1$Diag1)
keepall<-keep
}
for(i in 1:492){
keep<-grep(ICD_Filtered[i,1],train$Diag1)
keepall<-keep
}
train1<-train1[keep,]
train<-train[keep,]
train<-train[keep,]
View(train)
keepall<-c()
for(i in 1:492){
keep<-grep(ICD_Filtered[i,1],train$Diag1)
keepall<-keep+keepall
}
train<-train[keep,]
#Filters out unnecessary columns
train <-df %>% select(
-Type_Bill,
-Fed_Tax_SubID,
-Fed_Tax_Num,
-Admission_Type,
-Admission_Source,
-Do_Not_Resuscitate,
-Accident_St,
-starts_with("Units_Service"), #[1:18]
-Primary_Health_Plan_Id,
-Secondary_Health_Plan_Id,
-Tertiary_Health_Plan_Id,
-Primary_Patient_Rel_Insr,
-Secondary_Patient_Rel_Insr,
-Tertiary_Patient_Rel_Insr,
-Dx_Px_Qualifier,
-starts_with("POA"), #[1:18]
-starts_with("Patient_Reason_Visit"),#[1:3],
-Prospect_Pay_Code,
-starts_with("Ecode"), #[1:3]
-starts_with("E_POA"), #[1:3]
-Type_ER_Visit,
-Outcome_ER_Visit,
-Inpatient_Flag,
-ER_Flag,
-PET_Flag,
-ASTC_Flag,
-Lithotripsy_Flag,
-MRI_MRA_Flag,
-Megavolt_Rad_Flag,
-CT_Flag,
-Fatal_Error_Flag,
-starts_with("Record_Num"), #[1:2]
-Bill_End,
-MUL,
-Patient_ID,
-TN_Co_Res,
-Payer_A,
-Payer_B,
-Payer_C,
-Amount_Counter,
-Race,
-LOS,
-DRG_Rank,
-Inpat_Record_Flag,
-ER_Record_Flag,
-ASTC_Record_Flag,
-Obs_23hr_Record_Flag,
-CON_Flag,
-Cumulative_Record_Flag,
-Reportable_Flag,
-TN_Co_Unk,
-Processing_Period,
-MS_MDC,
-MS_DRG,
-MS_DRG_4digit,
-HAC,
-Admit_From_ED_Flag,
-Wrong_Claim
)
keepall<-c()
for(i in 1:492){
keep<-grep(ICD_Filtered[i,1],train$Diag1)
keepall<-keep+keepall
}
train<-train[keep,]
View(train)
keep<-grep(ICD_Filtered[i,1],train$Diag1)
#Filters out unnecessary columns
train <-df %>% select(
-Type_Bill,
-Fed_Tax_SubID,
-Fed_Tax_Num,
-Admission_Type,
-Admission_Source,
-Do_Not_Resuscitate,
-Accident_St,
-starts_with("Units_Service"), #[1:18]
-Primary_Health_Plan_Id,
-Secondary_Health_Plan_Id,
-Tertiary_Health_Plan_Id,
-Primary_Patient_Rel_Insr,
-Secondary_Patient_Rel_Insr,
-Tertiary_Patient_Rel_Insr,
-Dx_Px_Qualifier,
-starts_with("POA"), #[1:18]
-starts_with("Patient_Reason_Visit"),#[1:3],
-Prospect_Pay_Code,
-starts_with("Ecode"), #[1:3]
-starts_with("E_POA"), #[1:3]
-Type_ER_Visit,
-Outcome_ER_Visit,
-Inpatient_Flag,
-ER_Flag,
-PET_Flag,
-ASTC_Flag,
-Lithotripsy_Flag,
-MRI_MRA_Flag,
-Megavolt_Rad_Flag,
-CT_Flag,
-Fatal_Error_Flag,
-starts_with("Record_Num"), #[1:2]
-Bill_End,
-MUL,
-Patient_ID,
-TN_Co_Res,
-Payer_A,
-Payer_B,
-Payer_C,
-Amount_Counter,
-Race,
-LOS,
-DRG_Rank,
-Inpat_Record_Flag,
-ER_Record_Flag,
-ASTC_Record_Flag,
-Obs_23hr_Record_Flag,
-CON_Flag,
-Cumulative_Record_Flag,
-Reportable_Flag,
-TN_Co_Unk,
-Processing_Period,
-MS_MDC,
-MS_DRG,
-MS_DRG_4digit,
-HAC,
-Admit_From_ED_Flag,
-Wrong_Claim
)
keep<-grep(ICD_Filtered[i,1],train$Diag1)
keep<-grep(as.character(ICD_Filtered[i,1]),train$Diag1)
ICD_Filtered[1,1]
ICD_Filtered[2,1]
ICD_Filtered[3,1]
library(gsheet)
# Reading in doc of IDC10codes
codes<-gsheet2tbl("https://docs.google.com/document/d/1e53UDsuHZwQAyVc8vAG69Al_tjXbnv6C/edit?usp=sharing")
# Reading in doc of IDC10codes
codes<-gsheet2tbl("https://docs.google.com/document/d/1e53UDsuHZwQAyVc8vAG69Al_tjXbnv6C/edit")
# Reading in doc of IDC10codes
codes<-gsheet2tbl("https://docs.google.com/document/d/1e53UDsuHZwQAyVc8vAG69Al_tjXbnv6C/edit?usp=sharing&ouid=101883700449258151197&rtpof=true&sd=true")
# Reading in doc of IDC10codes
codes<-gsheet2tbl("C:\Users\alane\Downloads\Supplementary Tables 1 and 2.docx")
# Reading in doc of IDC10codes
codes<-gsheet2tbl("C:/Users/alane/Downloads/Supplementary Tables 1 and 2.docx")
# Reading in doc of IDC10codes
codes<-gsheet::gsheet2tbl("C:/Users/alane/Downloads/Supplementary Tables 1 and 2.docx")
# Reading in doc of IDC10codes
codes<-gsheet::gsheet2tbl("https://docs.google.com/document/d/1e53UDsuHZwQAyVc8vAG69Al_tjXbnv6C/edit")
install.packages("officer")
library(officer)
######################## Libraries and Data sets ####################
# June 23rd 2022 | Start of exploration and cleaning!
#####################################################################
library(tidyverse)
library(stringr)
library(gsheet)
setwd("D:/DataLab/syndemic")
codes <- read_csv("codes.csv")
View(codes)
# Possibly useful code but not the most important--------------------
#####################################################################
# Reading in doc of IDC10codes and creating codes csv----------------
icd<-gsheet2tbl("https://docs.google.com/spreadsheets/d/1hrniE4MIjZKVABg2DMR_tnKOt-SuIdPXYkzszWjQqbA/edit?usp=sharing")
# Making a column with codes.
# Noting that codes with astrid needs to be searched as start with, not fixed code.
icd<-icd %>% mutate(code = substr(icd$diagnosis,1 , 7 )) %>%mutate( astrid = ifelse(str_detect(icd$diagnosis, "[*]"),TRUE,FALSE))
# Getting rid of astrid or, period from codes.
icd$code <- icd$code %>% str_replace_all("[.]","") %>% str_replace_all("[*]","")
View(icd)
# Only run once, making this into csv for later use
write_csv(icd, "codes.csv")
setwd("D:/DataLab/syndemic")
gc()
codes <- read_csv("codes.csv")
#####################################################################
# This data is already filtered for choosen column values!
data<-read_csv("impdata.csv")
#####################################################################
# New Correct way of cleaning data-----------------------------------
# Making all diagnosis into one column!
# For all data change all trainpl into data
trainpl<-data %>%
select( ...1,
Diag1:Diag18
)
trainpl<-trainpl %>% pivot_longer(starts_with("Diag"))
# Get codes that tell us with what it should start with
swdf<-codes %>% filter(astrid)
View(swdf)
# Get codes that tell us with what it should start with
swv<-codes %>% filter(astrid) %>% pull(code)
# Look for any person id that has codes that start with any of our start with patterns
swfinal<-trainpl %>%
filter(substr(value,1,3) %in% swv )%>%
filter( !(substr(value,1,1) == "T" & (substr(value,nchar(value)-1,nchar(value)-1)=="5"|substr(value,nchar(value)-1,nchar(value)-1)=="6" )))
# Get codes that are fixed and we only want them to match that specific code
fixedv<-codes %>% filter(!astrid) %>% pull(fixeddf,code)
# Get codes that are fixed and we only want them to match that specific code
fixedv<-codes %>% filter(!astrid) %>% pull(code)
# Get codes that are fixed and we only want them to match that specific code
fixedv<-codes %>% filter(!astrid) %>% pull(code)
# Look for any person id that has code that matches any of our fixed codes
fixedfinal<-trainpl %>% filter(value %in% fixedv)
fidv<-fidv %>% c(pull(fixedfinal,...1), pull(swfinal,...1)) %>% unique(fidv)
fidv<-fidv %>% c(pull(fixedfinal,...1), pull(swfinal,...1))
fidv<-c(pull(fixedfinal,...1), pull(swfinal,...1))
fidv<-unique(fidv)
# Get person with ids that we got and care about
cleands<-data %>% filter( ...1 %in% fidv)
# Clean more, get rid of some more columns
cleands<-cleands %>% select(-starts_with("HCPC_Rate"),
-Tot_Charges_Summed,
-Tot_Charges_Analysis,
-Tot_Charges_Recorded,
-Obs_Unit_Flag,
-CostWt,
-starts_with("Proc"),
-Bill_Number,
-Record_Seq_Num,
-Form_Type,
-Accident_Code,
-Admit_Diag_Cd
)
write_csv(cleands,"m_data.csv")
gc()
setwd("D:/DataLab/syndemic")
codes <- read_csv("codes.csv")
# Add boolean value for SUD------------------------------------------
syndata<-read_csv("m_data.csv")
synpl<-syndata %>%
select( ...1,
Diag1:Diag18
)
synpl<-syndata %>%
select( ...1,
Diag1:Diag18
)
synpl<-synpl %>% pivot_longer(starts_with("Diag"))
sudcodes<-codes %>% filter(sud)
sudcode_a<-codes %>% filter(sud) %>% filter(astrid)
View(sudcodes)
View(sudcode_a)
# Vector of sud codes that we need to find starts with
sudcode_a<-codes %>% filter(sud) %>% filter(astrid) %>% pull(code)
# Vector of sud codes that we need to find fixed
sudcode_f<-codes %>% filter(sud) %>% filter(!astrid) %>% pull(code)
# pull ids that match one of these
sudids<- synpl %>% filter(value %in% sudcode_f | substr(value,1,3) %in% sudcode_a) %>%
filter( !(substr(value,1,1) == "T" & (substr(value,nchar(value)-1,nchar(value)-1)=="5"|substr(value,nchar(value)-1,nchar(value)-1)=="6" ))) %>%
pull(..1) %>% unique()
View(syndata)
# pull ids that match one of these
sudids<- synpl %>% filter(value %in% sudcode_f | substr(value,1,3) %in% sudcode_a) %>%
filter( !(substr(value,1,1) == "T" & (substr(value,nchar(value)-1,nchar(value)-1)=="5"|substr(value,nchar(value)-1,nchar(value)-1)=="6" ))) %>%
pull(...1) %>% unique()
# Add column that says true if id is in this vector
syndata<-syndata %>% mutate(sud = ifelse(...1 %in% sudids, TRUE, FALSE))
View(syndata)
# Add boolean value for ENDO-----------------------------------------
# Vector of sud codes that we need to find fixed
endocode_f<-codes %>% filter(endo) %>% pull(code)
# Add boolean value for ENDO-----------------------------------------
# Vector of sud codes that we need to find fixed
endocode_f<-codes %>% filter(endo) %>% pull(code)
# pull ids that match one of these
endoids<- synpl %>% filter(value %in% endocode_f) %>%
pull(...1) %>% unique()
# pull ids that match one of these
endoids<- synpl %>% filter(value %in% endocode_f) %>%
pull(...1) %>% unique()
# Add column that says true if id is in this vector
syndata<-syndata %>% mutate(endo = ifelse(...1 %in% endoids, TRUE, FALSE))
# Add boolean value for SSTVI----------------------------------------
# Vector of sud codes that we need to find starts with
sstcode_a<-codes %>% filter(sstvi) %>% filter(astrid) %>% pull(code)
# Vector of sud codes that we need to find fixed
sstcode_f<-codes %>% filter(sstvi) %>% filter(!astrid) %>% pull(code)
# pull ids that match one of these
sstids<- synpl %>% filter(value %in% sstcode_f | substr(value,1,3) %in% sstcode_a) %>%
pull(...1) %>% unique()
# Add column that says true if id is in this vector
syndata<-syndata %>% mutate(sstvi = ifelse(...1 %in% sstids, TRUE, FALSE))
# Add boolean values for Ost-----------------------------------------
# Vector of ost codes that we need to find starts with
ostcode_a<-codes %>% filter(osteomyelitis) %>% filter(astrid) %>% pull(code)
# Vector of ost codes that we need to find fixed
ostcode_f<-codes %>% filter(osteomyelitis) %>% filter(!astrid) %>% pull(code)
# pull ids that match one of these
ostids<- synpl %>% filter(value %in% ostcode_f | substr(value,1,3) %in% ostcode_a) %>%
pull(...1) %>% unique()
# Add column that says true if id is in this vector
syndata<-syndata %>% mutate(ost = ifelse(...1 %in% ostids, TRUE, FALSE))
# Add boolean value for Sepsis---------------------------------------
# Vector of sepsis codes that we need to find starts with
sepcode_a<-codes %>% filter(sepsis) %>% filter(astrid) %>% pull(code)
# Vector of sepsis codes that we need to find fixed
sepcode_f<-codes %>% filter(sepsis) %>% filter(!astrid) %>% pull(code)
# pull ids that match one of these
sepids<- synpl %>% filter(value %in% sepcode_f | substr(value,1,3) %in% sepcode_a) %>%
pull(...1) %>% unique()
# Add column that says true if id is in this vector
syndata<-syndata %>% mutate(sepsis = ifelse(...1 %in% sepids, TRUE, FALSE))
setwd("D:/DataLab/syndemic")
write_csv(syndata, "masterdata.csv")
######################## Libraries and Data sets ####################
# June 27rd 2022 | Start of exploration!
#####################################################################
library(tidyverse)
library(ggthemes)
setwd("D:/DataLab/syndemic")
data<-read_csv("masterdata.csv")
#
data %>% filter(sud&sstvi) %>% tally()
View(data)
