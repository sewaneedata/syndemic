---
title: "End The Syndemic"
author: "DataLab"
date: '2022'
runtime: shiny
output:
  flexdashboard::flex_dashboard:
    logo: /Users/erteam/Desktop/Syndemic Project/syndemic/syndemiclogo.png
    theme:
      version: 4
      bg: "#FAFBFE"
      fg: "#555555" 
      primary: "#91BAA7"
      navbar-bg: "#9A77C7"
      base_font: 
        google: Prompt
      heading_font:
        google: Open Sans
      code_font:
        google: 
          # arguments to sass::font_google() 
          family: sans_serif
          local: false
    vertical_layout: fill
    
---

```{r setup, include=FALSE}

library(flexdashboard)
library(shiny)
library(tidyverse)
library(DT)
library(plotly)
library(leaflet)
library(leaflet.extras)
library(gsheet)
library(rgdal)
library(raster)
library(tigris)
library(RColorBrewer)
library(ggVennDiagram)
library(forcats)
library(lubridate)
library(patchwork)
library(tidyr)

pdf(NULL)

setwd("/Users/erteam/Desktop/Syndemic Project/syndemic")

# Reading in data of locations of SEP
locations<-gsheet2tbl("https://docs.google.com/spreadsheets/d/1sb4P_7-UkcpkmENZ_DpMI45wRY7oItIFbv-0suLmz7U/edit?usp=sharing")
# Creating a column named label
locations<-locations %>% mutate(label = paste0("Name : ",name,"<br/>"," Address :",address,"<br/>","Phone :",phone,"<br/>" ) %>% lapply(htmltools::HTML))

# Reading in master data
masterdata<-read_csv("masterdataphi.csv")

# Reading in population by county data
popbycounty<-read_csv("SDC_TN_PL20_CountyPopChange.csv") 
popbycounty<-popbycounty %>% dplyr::select(County,`Population 2020`) %>% rename(county = County) %>% mutate(county = paste(county,"County"))

# Reading in data of zip codes and their county name
zips<-read.csv("countybyid.csv")

# Merging master data with county by ids
masterdata<-inner_join(zips,masterdata, by = "...1" ) %>% filter(state == "TN")
masterdata<-inner_join(popbycounty,masterdata, by = "county")
masterdata<-masterdata %>% separate(col=Patient_Race_Ethnicity,into=c( "Race", "Ethnicity"),sep= 1)
# Adding the real labels to race and ethnicity
masterdata<-masterdata %>% mutate(Race = ifelse(Race == 1,"White or Caucasian",
                                                ifelse(Race == 2,"Black or African American",
                                                       ifelse(Race == 3,"Other Race",
                                                              ifelse(Race == 4,"Other Race",
                                                                     ifelse(Race == 5,"Other Race","Unknown Race"))))))
#
masterdata<-masterdata %>% mutate(Ethnicity = ifelse(Ethnicity == 1,"Hispanic Origin",
                                                     ifelse(Ethnicity ==3,"Not Hispanic Origin","Hispanic Origin Unknown")))
#

# Reading in spatial polygon data for map
s <- shapefile("/Users/erteam/Desktop/Syndemic Project/tl_2021_us_county") 
boundaries <-subset(s, s@data$STATEFP == "47")

# Making color pallet based on SUD in county
paldata<-masterdata %>% filter(sud) %>% group_by(county) %>% summarise(total = n())

# Making vector of total number of cases by county.

# Adding county total to spatial data frame
boundaries<-geo_join(boundaries, paldata, by_sp ="NAMELSAD" , by_df ="county")
boundaries<-geo_join(boundaries, popbycounty, by_sp = "NAMELSAD", by_df ="county")
boundaries@data<-boundaries@data %>% mutate(percap = (total/Population.2020)*100)

mean(boundaries@data$percap)

# Making palette for shading of map
pal <- colorNumeric(
  palette = "Blues",
  domain = boundaries@data$percap)

#
syringes <- makeAwesomeIcon(
  icon = "hospital user",
  iconColor = "#FAFBFE",
  markerColor ="purple",
  library = "fa"
)

  #Formats data, adds a months column, makes an age groups column and then a quarter columns for the year
md_phi_jacobnf <- 
  masterdata %>% 
  mutate(creation_dt = mdy(creation_dt)) %>% 
  mutate(months = month(creation_dt)) %>% 
  mutate(Age_Groups = ifelse(Age %in% 0:17, '0-17', 
                             ifelse(Age %in% 18:24, '18-24',
                                    ifelse(Age %in% 25:34, '25-34',
                                           ifelse(Age %in% 35:44, '35-44',
                                                  ifelse(Age %in% 45:54, '45-54',
                                                         ifelse(Age %in% 55:64, '55-64', '65+'))))))) %>% 
  mutate(quarter = ifelse(months %in% 1:3, 1,
                          ifelse(months %in% 4:6, 2,
                                 ifelse(months %in% 7:9, 3, 4)))) 

  md_phi_jacob<-md_phi_jacobnf %>% filter(!Age_Groups == '65+', !Age_Groups == '0-17')

```

```{r reactive}

df_map<-reactive({
  
  if("All" %in% input$county_select){
    return(boundaries)
  }
  # Select only counties that have been selected!
  df<-subset(boundaries, boundaries@data$NAMELSAD %in% input$county_select)
  return(df)

})

# for sud and endo or sstvi
df1<-reactive({
  
  if(input$gender == "Both"){
    
    if("All" %in% input$Race ){
      df<-md_phi_jacob %>%
        filter(sud&(endo|sstvi)) %>%
        group_by(Age_Groups, quarter) %>%
        tally()
      return(df)
    }
    else{
      df<-md_phi_jacob %>%
        filter(Race %in% input$Race)%>%
        filter(sud&(endo|sstvi)) %>% 
        group_by(Age_Groups, quarter) %>% 
        tally()
      return(df)
    }
    
  }
  else{
    if("All" %in% input$Race){
      df<-md_phi_jacob %>%
        filter(Patient_Sex %in% input$gender)%>%
        filter(sud&(endo|sstvi)) %>%
        group_by(Age_Groups, quarter) %>%
        tally()
      return(df)
    }
    else{
      df<-md_phi_jacob %>%
        filter(Race %in% input$Race)%>%
        filter(Patient_Sex %in% input$gender)%>% 
        filter(sud&(endo|sstvi)) %>% 
        group_by(Age_Groups, quarter) %>% 
        tally()
      return(df)
    }
  }
})

# for sud and endo or sstvi
df1b<-reactive({
  
  if(input$gender == "Both"){
    
    if("All" %in% input$Race ){
      df<-md_phi_jacob %>%
        filter((endo|sstvi)) %>%
        group_by(Age_Groups, quarter) %>%
        tally()
      return(df)
    }
    else{
      df<-md_phi_jacob %>%
        filter(Race %in% input$Race)%>%
        filter((endo|sstvi)) %>% 
        group_by(Age_Groups, quarter) %>% 
        tally()
      return(df)
    }
    
  }
  else{
    if("All" %in% input$Race){
      df<-md_phi_jacob %>%
        filter(Patient_Sex %in% input$gender)%>%
        filter((endo|sstvi)) %>%
        group_by(Age_Groups, quarter) %>%
        tally()
      return(df)
    }
    else{
      df<-md_phi_jacob %>%
        filter(Race %in% input$Race)%>%
        filter(Patient_Sex %in% input$gender)%>% 
        filter((endo|sstvi)) %>% 
        group_by(Age_Groups, quarter) %>% 
        tally()
      return(df)
    }
  }
})

# for sud and endo
df2<-reactive({
  
  if(input$gender == "Both"){
    
    if("All" %in% input$Race){
      df<-md_phi_jacob %>%
        filter(sud&endo) %>%
        group_by(Age_Groups, quarter) %>%
        tally()
      return(df)
    }
    else{
      df<-md_phi_jacob %>%
        filter(Race %in% input$Race)%>%
        filter(sud&endo) %>% 
        group_by(Age_Groups, quarter) %>% 
        tally()
      return(df)
    }
    
  }
  else{
    if("All" %in% input$Race){
      df<-md_phi_jacob %>%
        filter(Patient_Sex %in% input$gender)%>%
        filter(sud&endo) %>%
        group_by(Age_Groups, quarter) %>%
        tally()
      return(df)
    }
    else{
      df<-md_phi_jacob %>%
        filter(Race %in% input$Race)%>%
        filter(Patient_Sex %in% input$gender)%>% 
        filter(sud&endo) %>% 
        group_by(Age_Groups, quarter) %>% 
        tally()
      return(df)
    }
  }
})

#for sud and osto
df3<-reactive({
  
  if(input$gender == "Both"){
    
    if("All" %in% input$Race){
      df<-md_phi_jacob %>%
        filter(sud&ost) %>%
        group_by(Age_Groups, quarter) %>%
        tally()
      return(df)
    }
    else{
      df<-md_phi_jacob %>%
        filter(Race %in% input$Race)%>%
        filter(sud&ost) %>% 
        group_by(Age_Groups, quarter) %>% 
        tally()
      return(df)
    }
    
  }
  else{
    if("All" %in% input$Race){
      df<-md_phi_jacob %>%
        filter(Patient_Sex %in% input$gender)%>%
        filter(sud&ost) %>%
        group_by(Age_Groups, quarter) %>%
        tally()
      return(df)
    }
    else{
      df<-md_phi_jacob %>%
        filter(Race %in% input$Race)%>%
        filter(Patient_Sex %in% input$gender)%>% 
        filter(sud&ost) %>% 
        group_by(Age_Groups, quarter) %>% 
        tally()
      return(df)
    }
  }
})

# For sud and sepsis
df4<-reactive({
  
  if(input$gender == "Both"){
    
    if("All" %in% input$Race){
      df<-md_phi_jacob %>%
        filter(sud&sepsis) %>%
        group_by(Age_Groups, quarter) %>%
        tally()
      return(df)
    }
    else{
      df<-md_phi_jacob %>%
        filter(Race %in% input$Race,Ethnicity %in% input$eth)%>%
        filter(sud&sepsis) %>% 
        group_by(Age_Groups, quarter) %>% 
        tally()
      return(df)
    }
    
  }
  else{
    if("All" %in% input$Race){
      df<-md_phi_jacob %>%
        filter(Patient_Sex %in% input$gender)%>%
        filter(sud&sepsis) %>%
        group_by(Age_Groups, quarter) %>%
        tally()
      return(df)
    }
    else{
      df<-md_phi_jacob %>%
        filter(Race %in% input$Race)%>%
        filter(Patient_Sex %in% input$gender)%>% 
        filter(sud&sepsis) %>% 
        group_by(Age_Groups, quarter) %>% 
        tally()
      return(df)
    }
  }
})

#for sud and sstvi
df5<-reactive({
  
  if(input$gender == "Both"){
    
    if("All" %in% input$Race){
      df<-md_phi_jacob %>%
        filter(sud&sstvi) %>%
        group_by(Age_Groups, quarter) %>%
        tally()
      return(df)
    }
    else{
      df<-md_phi_jacob %>%
        filter(Race %in% input$Race)%>%
        filter(sud&sstvi) %>% 
        group_by(Age_Groups, quarter) %>% 
        tally()
      return(df)
    }
    
  }
  else{
    if("All" %in% input$Race){
      df<-md_phi_jacob %>%
        filter(Patient_Sex %in% input$gender)%>%
        filter(sud&sstvi) %>%
        group_by(Age_Groups, quarter) %>%
        tally()
      return(df)
    }
    else{
      df<-md_phi_jacob %>%
        filter(Race %in% input$Race)%>%
        filter(Patient_Sex %in% input$gender)%>% 
        filter(sud&sstvi) %>% 
        group_by(Age_Groups, quarter) %>% 
        tally()
      return(df)
    }
  }
})


```

Home Page  <!--{data-orientation=rows} -->
=======================================

Column
---------------------------------------
<img src="/Users/erteam/Desktop/Syndemic Project/syndemic/HomePage.png" width=100%> 

Column
---------------------------------------
<img src="/Users/erteam/Desktop/Syndemic Project/syndemic/Glossary.png" width = 100%>



Important Visuals! {style="position:relative;"}
=======================================

Sidebar {.sidebar}
---------------------------------------
###

```{r sidebar}

race<-masterdata %>% pull(Race) %>% unique() %>% sort()

radioButtons("Race",
            "Choose Race",
            choices = c("All",race),
            selected = "All")

gender<-masterdata %>% filter(!Patient_Sex=="9") %>%  pull(Patient_Sex) %>% unique() %>% sort()

radioButtons("gender",
            "Choose Gender",
            choices = c("Both",gender),
            selected = "Both")
```

Column {style="height:140pc;"}
---------------------------------------

### Whole picture

```{r}

  total<-masterdata%>% filter(sud&(endo|sstvi)) %>% nrow()
total2<-masterdata %>% filter((endo|sstvi)) %>% nrow()
  #Plots SUDS and SSTVI or Endo

  b1<-ggplotly(ggplot(data = md_phi_jacobnf %>%
                               filter(sud&(sstvi|endo)) %>%
                               group_by(quarter) %>%
                               tally(),
       aes(x = quarter,
           y = n/total)) +
  geom_point(color = '#1B365D') +
  geom_line(color = '#1B365D') +
  labs(title = 'Trends in Hospitalization for Substance Use  and all SSTVIs or Endocarditis',
       subtitle = 'TN Hospitals 2019 | Inpatient and Outpatient',
       caption = 'End the Syndemic | DataLab 2022',
       x = 'Yearly Quarter',
       y = 'Total Patients')+ expand_limits(y = 0))
  
  #Plots SUDS and SSTVI or Endo
b2<-ggplotly(ggplot(data = md_phi_jacobnf %>%
                               filter(sstvi|endo) %>%
                               group_by(quarter) %>%
                               tally(),
       aes(x = quarter,
           y = n/total2 )) +
  geom_point(color = '#1B365D') +
  geom_line(color = '#1B365D') +
  labs(title = 'Trends in Hospitalization for all SSTVIs or Endocarditis',
       subtitle = 'TN Hospitals 2019 | Inpatient and Outpatient',
       caption = 'End the Syndemic | DataLab 2022',
       x = 'Yearly Quarter',
       y = 'Total Patients')+ expand_limits(y = 0))

subplot(b1,b2,shareY=TRUE)

```

### Whole picture by age

```{r}

total3<-md_phi_jacob%>% filter(sud&(endo|sstvi)) %>% nrow()
total4<-md_phi_jacob%>% filter((endo|sstvi)) %>% nrow()

renderPlotly({
  
  #Plots SUDS and SSTVI or Endo
c1<-ggplotly(ggplot(df1(),
       aes(x = quarter,
           y = n/total3*100,
           color = Age_Groups)) +
  geom_point() +
  geom_line() +
  labs(title = 'Trends in Hospitalization for Substance Use  and all SSTVIs or Endocarditis',
       subtitle = 'TN Hospitals 2019 | Inpatient and Outpatient',
       caption = 'End the Syndemic | DataLab 2022',
       x = 'Yearly Quarter',
       y = 'Total Patients') +
  scale_color_manual(values = c('#C11701', '#B1B1B1', '#1B365D', '#9A77C7', '#91BAA7')))
  
c2<-ggplotly(ggplot(df1b(),
       aes(x = quarter,
           y = n/total4*100,
           color = Age_Groups)) +
  geom_point() +
  geom_line() +
  labs(title = 'Trends in Hospitalization for all SSTVIs or Endocarditis',
       subtitle = 'TN Hospitals 2019 | Inpatient and Outpatient',
       caption = 'End the Syndemic | DataLab 2022',
       x = 'Yearly Quarter',
       y = 'Total Patients') +
  scale_color_manual(values = c('#C11701', '#B1B1B1', '#1B365D', '#9A77C7', '#91BAA7')))

subplot(c1,style(c2, showlegend=F),shareY=TRUE) %>% layout(title ='Trends in Hospitalization by age group',
                                                           annotations = list(
                                                             list(x=.2,y=.1,text ='Trends in Hospitalization for Substance Use  and all SSTVIs or Endocarditis'),
                                                             list(x=.8,y=.1,text ='Trends in Hospitalization for all SSTVIs or Endocarditis')))

})

```

### TRENDS

```{r}
renderPlotly({
#Plots SUDS and endo
  b1<-ggplotly(ggplot(df2(),
      aes(x = quarter,
          y = n,
          color = Age_Groups)) +
  geom_point() +
  geom_line() +
  labs(title = 'Trends in Hospitalization for Substance Use  and Endocarditis',
       subtitle = 'TN Hospitals 2019 | Inpatient and Outpatient',
       caption = 'End the Syndemic | DataLab 2022',
       x = 'Yearly Quarter',
       y = 'Total Patients') +
  scale_color_manual(values = c('#C11701', '#B1B1B1', '#1B365D', '#9A77C7', '#91BAA7')))

  
  #Plots SUDS and osteo
    b2<-ggplotly(ggplot(data = df3(),
       aes(x = quarter,
           y = n,
           color = Age_Groups)) +
  geom_point() +
  geom_line() +
  labs(title = 'Trends in Hospitalization for Substance Use  and Ostemyelitis',
       subtitle = 'TN Hospitals 2019 | Inpatient and Outpatient',
       caption = 'End the Syndemic | DataLab 2022',
       x = 'Yearly Quarter',
       y = 'Total Patients') +
  scale_color_manual(values = c('#C11701', '#B1B1B1', '#1B365D', '#9A77C7', '#91BAA7')))
  
    
  #Plots SUDS and sepsis
b3<-ggplotly(ggplot(data = df4(),
       aes(x = quarter,
           y = n,
           color = Age_Groups)) +
  geom_point() +
  geom_line() +
  labs(title = 'Trends in Hospitalization for Substance Use  and Sepsis',
       subtitle = 'TN Hospitals 2019 | Inpatient and Outpatient',
       caption = 'End the Syndemic | DataLab 2022',
       x = 'Yearly Quarter',
       y = 'Total Patients') +
  scale_color_manual(values = c('#C11701', '#B1B1B1', '#1B365D', '#9A77C7', '#91BAA7')))
  
  
  #Plots SUDS and sstvi
b4<-ggplotly(ggplot(data = df5(),
       aes(x = quarter,
           y = n,
           color = Age_Groups)) +
  geom_point() +
  geom_line() +
  labs(title = 'Trends in Hospitalization for Substance Use  and all SSTVIs',
       subtitle = 'TN Hospitals 2019 | Inpatient and Outpatient',
       caption = 'End the Syndemic | DataLab 2022',
       x = 'Yearly Quarter',
       y = 'Total Patients') +
  scale_color_manual(values = c('#C11701', '#B1B1B1', '#1B365D', '#9A77C7', '#91BAA7')))

annotations = list( 
  list( 
    x = 0.2,  
    y = 1.0,  
    text = "Trends in Hospitalizations for Substance Use  and Endocarditis",  
    xref = "paper",  
    yref = "paper",  
    xanchor = "center",  
    yanchor = "bottom",  
    showarrow = FALSE 
  ),  
  list( 
    x = 0.8,  
    y = 1,  
    text = "Trends in Hospitalizations for Substance Use  and Osteomyelitis",  
    xref = "paper",  
    yref = "paper",  
    xanchor = "center",  
    yanchor = "bottom",  
    showarrow = FALSE 
  ),  
  list( 
    x = 0.2,  
    y = 0.49,  
    text = "Trends in Hospitalizations for Substance Use  and Sepsis",  
    xref = "paper",  
    yref = "paper",  
    xanchor = "center",  
    yanchor = "bottom",  
    showarrow = FALSE 
  ),
  list( 
    x = 0.8,  
    y = 0.49,  
    text = "Trends in Hospitalization for Substance Use  and all SSTVIs",  
    xref = "paper",  
    yref = "paper",  
    xanchor = "center",  
    yanchor = "bottom",  
    showarrow = FALSE 
  ))



subplot(style(b1,showlegend = FALSE),style(b2,showlegend = FALSE),style(b3,showlegend = FALSE),b4,nrows = 2, shareX = TRUE ) %>% layout(title = "Trends over time for Substance Use " , annotations = annotations)
 })
```

Visualizing Cost! {data-orientation=rows}
=======================================

Row {.tabset .tabset-fade}
---------------------------------------

### Graph 1

```{r}

#Sets up an object that groups by primary payer, 
#sums the total costs each payer paid for syndemic patients,
#only saves the top 5,
#and then adds a new column, gov, for if it was funded by the government or not
md_top_payers <- masterdata %>% 
  filter(sud, endo | sstvi) %>% 
  group_by(Primary_Payer_Class_Cd) %>%
  summarise(total = sum(Total_Tot_Chrg)) %>% 
  arrange(desc(total)) %>% 
  head(5) %>% 
  mutate(gov = ifelse(Primary_Payer_Class_Cd %in% c('M','K','J', '8'), TRUE, FALSE))

#Renames the primary payers to their common name
md_top_payers$Primary_Payer_Class_Cd <- fct_recode(md_top_payers$Primary_Payer_Class_Cd,
             'Medicare' = 'M',
             'Medicare Advantage' = 'K',
             'Self-Pay' = 'P',
             'Blue Care' = 'J',
             'Americhoice' = '8')
  
  #Plots the top 5 primary payers by their costs paid for syndemic patients
a1<-ggplotly(ggplot(data = md_top_payers, 
       aes(y = total/100000000, 
           x = reorder(Primary_Payer_Class_Cd, -total), 
           fill = gov ) ) +
  geom_col() +
  labs(title = 'Total Costs Covered by Top 5 Healthcare Providers',
       subtitle = 'TN Hospitals 2019 | Inpatient and Outpatient',
       caption = 'End the Syndemic | DataLab 2022',
       x = 'Primary Provider',
       y = 'Cost Paid (in millions of US dollars)') +
  scale_fill_manual(md_top_payers, values = c('#1B365D', '#91BAA7'), 
                    labels = c('Privately Funded', 'Government Funded', '', '', ''),
                    name = 'Color Legend:') +
  theme(legend.position = 'bottom') +
  theme(axis.text.x = element_text(angle = 10)))
  

#creates a object that groups by primary payer, summaries total paid by provider,
#and then adds gov columns to determine if government funded or privately funded
md_big_gov <- masterdata %>% 
  filter(sud, endo | sstvi) %>% 
  group_by(Primary_Payer_Class_Cd) %>% 
  summarise(total = sum(Total_Tot_Chrg)) %>% 
  arrange(desc(total)) %>% 
  mutate(gov = ifelse(Primary_Payer_Class_Cd %in% c('C','D','M','W','N','K','J',11, 12, 8, 10, 'Q', 'T'), 
                      'Government Funded', 
                      'Privately Funded'))
  
#Plots government vs private total funding for syndemic patients
a2<-ggplotly(ggplot(data = md_big_gov, 
       aes(y = total/100000000, 
           x = gov, 
           fill = gov ) ) +
  geom_col() +
  labs(title = 'Total Costs Paid by Government and Private Providers',
       caption = 'End the Syndemic | DataLab 2022',
       subtitle = 'TN Hospitals 2019 | Inpatient and Outpatient',
       x = 'Primary Payer',
       y = 'Cost Paid (in millions of US dollars)') +
  scale_fill_manual(md_top_payers, values = c('#91BAA7', '#1B365D'), 
                    labels = c('Privately Funded', 'Government Funded'),
                    name = 'Color Legend:'))
  
subplot(a2,style(a1, showlegend=F))

```

### Graph 3

```{r, echo=FALSE}

#Creates a list of SUDs & ENDO or SSTVI for the ggvenn package to read
syndemic_list <- 
  list('SUDs' = which(masterdata$sud), 
       'SSTVIs or Endocarditis' = which(masterdata$endo | masterdata$sstvi))

#Creates a venn diagram showing overlap in SUDS and syndemic related ICD-10s
ggVennDiagram(syndemic_list,
              label_size = 4,
              label_alpha = 0.3,
              label = c('count')) +
  theme(legend.position = '0') +
  labs(title = 'Hospitalization overlap for substance use and infectious sequela of interest',
       subtitle = 'TN Hospitals 2019 | Inpatient and Outpatient',
       caption = 'End the Syndemic | DataLab 2022') +
  scale_color_manual(values = c('black','black')) +
  scale_fill_gradientn(colors = c('#555555', '#91BAA7', '#555555', '#1B365D'))

```

### Graphs

```{r}

 #Adds a gov column, private or publicly funded, to md_phi
md_phi_jacob <- md_phi_jacob %>%
  mutate(gov = ifelse(Primary_Payer_Class_Cd %in% c('C','D','M','W','N','K','J',11, 12, 8, 10, 'Q', 'T'), 
                      'Government Funded', 
                      'Privately Funded'))

#Changes format of # from exponential to normal
options(scipen = 999)

#Plots SUDS and endo
g1<-ggplotly(ggplot(data = md_phi_jacob %>% 
         filter(sud,endo),
       aes(x = quarter,
           y = Total_Tot_Chrg/100,
           fill = gov)) +
  geom_col(position = 'dodge') +   
  labs(title = 'Trends in Costs for Substance Use  and Endocarditis',
                      subtitle = 'TN Hospitals 2019 | Inpatient and Outpatient',
                      caption = 'End the Syndemic | DataLab 2022',
                      x = 'Yearly Quarter',
                      y = 'Cost (In US Dollars)',
       fill = 'Primary Payer:') +
  theme(legend.position = 'none') +
  scale_fill_manual(values = c('#91BAA7', '#1B365D')))


  #Adds a gov column, private or publicly funded, to md_phi
md_phi_jacob <- md_phi_jacob %>%
  mutate(gov = ifelse(Primary_Payer_Class_Cd %in% c('C','D','M','W','N','K','J',11, 12, 8, 10, 'Q', 'T'), 
                      'Government Funded', 
                      'Privately Funded'))


  
  #Plots SUDS and ost
g2<-ggplotly(ggplot(data = md_phi_jacob %>% 
         filter(sud, ost),
       aes(x = quarter,
           y = Total_Tot_Chrg/100,
           fill = gov)) +
  geom_col(position = 'dodge') +
  labs(title = 'Trends in Costs for Substance Use  and Osteomyelitis',
                      subtitle = 'TN Hospitals 2019 | Inpatient and Outpatient',
                      caption = 'End the Syndemic | DataLab 2022',
                      x = 'Yearly Quarter',
                      y = 'Cost (In US Dollars)',
       fill = 'Primary Payer:') +
  theme(legend.position = 'none') +
  scale_fill_manual(values = c('#91BAA7', '#1B365D')))

  #Adds a gov column, private or publicly funded, to md_phi
md_phi_jacob <- md_phi_jacob %>%
  mutate(gov = ifelse(Primary_Payer_Class_Cd %in% c('C','D','M','W','N','K','J',11, 12, 8, 10, 'Q', 'T'), 
                      'Government Funded', 
                      'Privately Funded'))


  
  #Plots SUDS and sepsis
g3<-ggplotly(ggplot(data = md_phi_jacob %>% 
         filter(sud, sepsis),
       aes(x = quarter,
           y = Total_Tot_Chrg/100,
           fill = gov)) +
  geom_col(position = 'dodge') +
  labs(title = 'Trends in Costs for Substance Use  and Sepsis',
                      subtitle = 'TN Hospitals 2019 | Inpatient and Outpatient',
                      caption = 'End the Syndemic | DataLab 2022',
                      x = 'Yearly Quarter',
                      y = 'Cost (In US Dollars)',
       fill = 'Primary Payer:') +
  theme(legend.position = 'none') +
  scale_fill_manual(values = c('#91BAA7', '#1B365D')))
  

  #Adds a gov column, private or publicly funded, to md_phi
md_phi_jacob <- md_phi_jacob %>%
  mutate(gov = ifelse(Primary_Payer_Class_Cd %in% c('C','D','M','W','N','K','J',11, 12, 8, 10, 'Q', 'T'), 
                      'Government Funded', 
                      'Privately Funded'))


  
  #Plots SUDS and SSTVIs
g4<-ggplotly(ggplot(data = md_phi_jacob %>% 
         filter(sud, sstvi),
       aes(x = quarter,
           y = Total_Tot_Chrg/100,
           fill = gov)) +
  geom_col(position = 'dodge') +
  labs(title = 'Trends in Costs for Substance Use  and all SSTVIs',
                      subtitle = 'TN Hospitals 2019 | Inpatient and Outpatient',
                      caption = 'End the Syndemic | DataLab 2022',
                      x = 'Yearly Quarter',
                      y = 'Cost (In US Dollars)',
       fill = 'Primary Payer:') +
  theme(legend.position = 'bottom') +
  scale_fill_manual(values = c('#91BAA7', '#1B365D')))

annotations = list( 
  list( 
    x = 0.2,  
    y = 1.0,  
    text = "Trends in Costs for Substance Use  and Endocarditis",  
    xref = "paper",  
    yref = "paper",  
    xanchor = "center",  
    yanchor = "bottom",  
    showarrow = FALSE 
  ),  
  list( 
    x = 0.8,  
    y = 1,  
    text = "Trends in Costs for Substance Use  and Osteomyelitis",  
    xref = "paper",  
    yref = "paper",  
    xanchor = "center",  
    yanchor = "bottom",  
    showarrow = FALSE 
  ),  
  list( 
    x = 0.2,  
    y = 0.49,  
    text = "Trends in Costs for Substance Use  and Sepsis",  
    xref = "paper",  
    yref = "paper",  
    xanchor = "center",  
    yanchor = "bottom",  
    showarrow = FALSE 
  ),
  list( 
    x = 0.8,  
    y = 0.49,  
    text = "Trends in Costs for Substance Use  and all SSTVIs",  
    xref = "paper",  
    yref = "paper",  
    xanchor = "center",  
    yanchor = "bottom",  
    showarrow = FALSE 
  ))

subplot(style(g1,showlegend = FALSE),style(g2,showlegend = FALSE),style(g3,showlegend = FALSE),g4,nrows = 2, shareX = TRUE, shareY = TRUE ) %>% layout(title = "Trends in Cost for Substance Use " , annotations = annotations)
  
```

### Graph 8

```{r}

  #Adds a gov column, private or publicly funded, to md_phi
md_phi_jacob <- md_phi_jacob %>%
  mutate(gov = ifelse(Primary_Payer_Class_Cd %in% c('C','D','M','W','N','K','J',11, 12, 8, 10, 'Q', 'T'), 
                      'Government Funded', 
                      'Privately Funded'))

renderPlotly({
  
  #Plots SUDS and SSTVIs or Endo
ggplotly(ggplot(data = md_phi_jacob %>% 
         filter(sud, sstvi|endo),
       aes(x = quarter,
           y = Total_Tot_Chrg/100,
           fill = gov)) +
  geom_col(position = 'dodge') +
  labs(title = 'Trends in Costs for Substance Use  and Endocarditis or a SSTVI',
       subtitle = 'TN Hospitals 2019 | Inpatient and Outpatient',
       caption = 'End the Syndemic | DataLab 2022',
       x = 'Yearly Quarter',
       y = 'Cost (In US Dollars)',
       fill = 'Primary Payer:') +
  theme(legend.position = 'bottom') +
  scale_fill_manual(values = c('#91BAA7', '#1B365D')))

  
})

```

Map of Syringe Exchange Programs! {data-orientation=rows}
=======================================

Sidebar {.sidebar}
---------------------------------------
###

```{r loc_inp}

masterdatacountys<-masterdata %>% pull(county) %>% unique() %>% sort()

selectInput("county_select",
            "Choose county",
            choices = c("All",masterdatacountys),
            multiple = TRUE,
            selected = "All")

```

###

<font size="3" color = "#1B365D"> *This is a map from 2019, where each purple pin marks the location of a Syringe Exchange Clinic in the state of Tennessee.* 

**Glossary :** *Substance Use Disorder ( SUD )*</font>


Row
---------------------------------------

###

```{r}
renderValueBox({
  
  sepcount<-nrow(locations)
  
  valueBox("# of Syringe Exchange Programs in TN",
           value = sepcount,
           icon = "fa-syringe")
})
```

###

```{r}
renderValueBox({
  valueBox("# Counties in TN",
           value = 95,
           icon = "fa-building")
})
```

###

```{r}
renderValueBox({
  valueBox("# of people in TN",
           value = "6,910,840",
           icon = "fa-users")
})
```

Row
---------------------------------------

### Map

```{r}
renderLeaflet({
  
leaflet(locations) %>%
  addProviderTiles(providers$OpenStreetMap) %>% 
  addAwesomeMarkers(label = ~label, icon = syringes )%>%
  addPolygons(data = df_map(),
              color ="#FAFBFE",
              fillColor = ~pal(percap),
              fillOpacity = .6,
              weight = 2,
              opacity = .9,
              highlightOptions = highlightOptions(color = "#91BAA7", bringToFront = TRUE ),
              label = paste0("County : ",df_map()@data$NAMELSAD,"<br/>"," Percent of SUD in county : ",round(df_map()@data$percap,2)) %>% lapply(htmltools::HTML)) %>% 
  addControlGPS(options = gpsOptions(position = "topleft", activate = TRUE, 
                                             autoCenter = TRUE, maxZoom = 200, 
                                             setView = TRUE)) %>% 
    addLegend(pal = pal, 
            values = boundaries@data$percap, 
            opacity = 0.7, 
            title = htmltools::HTML("Percentage of SUD cases <br>
                                    by County <br>
                                    2019"),
            position = "bottomright")
  
})
```

About Us 
=======================================

Column
---------------------------------------

### DataLab 2022

![The Sewanee DataLab makes the power of data analytics accessible for the greater good. We accomplish this by training and supporting a new generation of data scientists who work exclusively on social impact projects.The Sewanee DataLab seeks to expand the definition of data science and what it means to be a data scientist by training undergraduate students, academics, and professionals from a wide range of disciplines.](/Users/erteam/Desktop/Syndemic Project/syndemic/IMG_0607.jpg)

```{r}



```

Column
---------------------------------------

### Delana 

![ Delana Turner (she/her) C'24 is a student at the University of the South from Hyattsville, Maryland. At Sewanee, she is majoring in American Studies while minoring in Politics and earning a certificate in Civic and Global Leadership. When she graduates in 2024, she intends to pursue a career in public policy. ](/Users/erteam/Desktop/Syndemic Project/syndemic/IMG_7015.jpg){#id .class }

### Alan

![Alan Kevin Espinoza (he/him) is a student at the University of the South from Houston, Texas. During his time at Sewanee, he has begun his major in Computer Science and Mathematics while working on being part of the 3-2 engineering program where after 3 years at Sewanee, he will do another 2 years studing Data Science at Washington University at St.Luios. On campus he is the President of the fraternity Gamma Sigma Phi, treasurer of the Hispanic Organization of Latino Awarness, helps his peers in the Academic Technology Center, and loves to rock climb on his free time. When he graduates, he intends to start his carrer as a data analyst or software engineer!](/Users/erteam/Desktop/Syndemic Project/syndemic/Dashboard/IMG-1319.jpg)

</p>

### Jacob

![Jacob Herron (he/him) C'24 is a student at the University of the South from Rickman, Tennessee. During his time at Sewanee, he has started his major in economics and is working on a minor in mathematics. On campus, he can be found teaching new fencers at Fowler, catching up with friends and professors at Stirlings, or helping his peers at his job in the library. When he gradautes, he intends to pursue a masters degree in economics in hopes of working as an economist.](/Users/erteam/Desktop/Syndemic Project/syndemic/IMG_5896.jpeg)

### Amber

![Amber Coyne (she/her) is a Public Health Advisor with the CDC skilled in community engagement, strategic planning, and innovative program development. Her work includes cross-sectoral collaborator liaising between nonprofits, local, state, and federal health agencies, as well as a diverse portfolio of experience including outbreak response, telemedicine implementation, public health social marketing, program evaluation, and community outreach. She is passionate about health equity, syndemic approaches, and public health capacity building.](/Users/erteam/Desktop/Syndemic Project/syndemic/IMG-AMBR.jpeg)


```{r}
ui<-fluidPage(
  
)

server<-function(input, ouput, session) {
  
}

shinyApp(ui,server)
```
